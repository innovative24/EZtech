<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>è¨˜æ†¶å°æœ¬æœ¬</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2b7cff">
<style>
  :root{--bg:#fff;--fg:#111;--muted:#666;--accent:#2b7cff;--line:#eee}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);padding:12px;z-index:2}
  header h1{margin:0;font-size:20px}
  .bar{display:flex;gap:8px;margin-top:8px}
  input[type="search"]{flex:1;padding:10px;border:1px solid var(--line);border-radius:10px}
  .btn{padding:10px 14px;border:1px solid var(--line);background:#f9f9f9;border-radius:10px}
  .btn.accent{background:var(--accent);border-color:var(--accent);color:#fff}
  main{padding:12px}
  form#addForm{display:grid;gap:8px;background:#fafafa;border:1px solid var(--line);padding:12px;border-radius:12px}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .hint{font-size:12px;color:var(--muted)}
  .list{margin-top:12px;display:grid;gap:10px}
  .card{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff}
  .thumb{width:64px;height:64px;border-radius:8px;object-fit:cover;background:#f0f0f0;border:1px solid var(--line)}
  .title{font-weight:600;margin:0 0 4px}
  .note{margin:0;color:var(--muted);font-size:13px}
  .actions{display:flex;gap:6px;align-items:center}
  .iconbtn{border:1px solid var(--line);background:#f8f8f8;border-radius:8px;padding:8px}
  label.chk{display:flex;align-items:center;gap:8px}
  .empty{color:var(--muted);text-align:center;margin:24px 0}
  footer{padding:16px;text-align:center;color:var(--muted);font-size:12px}
  /* å¸¸è²·å€ */
  .staples{margin-top:12px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fff}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{display:flex;align-items:center;gap:6px;border:1px solid var(--line);padding:8px 10px;border-radius:999px}
  .chip b{font-weight:600}
  .chip .plus{border:0;background:transparent;font-weight:700;cursor:pointer}
  .staples-bar{display:flex;gap:8px;margin-top:8px}
  @media (min-width:700px){ main{max-width:760px;margin:0 auto} }
</style>
</head>
<body>
<header>
  <h1>ğŸ“ è¨˜æ†¶å°æœ¬æœ¬</h1>
  <div class="bar">
    <input id="search" type="search" placeholder="æœå°‹é …ç›®æˆ–å‚™è¨»â€¦">
    <!-- åŸä¾†çš„å®‰è£/åŒ¯å‡º/åŒ¯å…¥é™„è¿‘ï¼ŒåŠ ä¸Šä¸€é¡† -->
    <button id="copyBackupBtn" class="btn">å‚™ä»½ï¼ˆè¤‡è£½ï¼‰</button>
    <button id="exportBtn" class="btn">åŒ¯å‡º</button>
    <button id="importBtn" class="btn">åŒ¯å…¥</button>
    <button id="installBtn" class="btn" style="display:none;">å®‰è£</button>
  </div>
</header>

<main>
  <form id="addForm">
    <div class="row">
      <input id="title" type="text" placeholder="è¦è²·ä»€éº¼ï¼Ÿï¼ˆä¾‹å¦‚ï¼šç‰›å¥¶ï¼‰" required>
      <input id="note" type="text" placeholder="å‚™è¨»ï¼ˆå“ç‰Œã€è¦æ ¼â€¦ï¼‰">
    </div>
    <div class="row">
      <input id="photo" type="file" accept="image/*" capture="environment">
      <button class="btn accent" type="submit">æ–°å¢</button>
    </div>
    <div class="row" style="align-items:center;">
      <label style="display:flex;align-items:center;gap:8px;">
        <input id="saveAsStaple" type="checkbox"> åŒæ™‚å­˜åˆ°å¸¸è²·æ¸…å–®
      </label>
    </div>
    <div class="hint">å¯ç›´æ¥æ‰“å­—å„²å­˜ï¼›è‹¥è¦æ‹ç…§ï¼Œé»ã€Œé¸æ“‡æª”æ¡ˆã€ã€‚ç…§ç‰‡æœƒè‡ªå‹•å£“ç¸®ï¼Œç¯€çœç©ºé–“ã€‚</div>
  </form>

  <!-- å¸¸è²·æ¸…å–® -->
  <section class="staples">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <strong>ğŸ“Œ å¸¸è²·æ¸…å–®</strong>
      <div class="staples-bar">
        <button id="addAllStaplesBtn" class="btn">ä¸€éµå…¨åŠ å…¥</button>
        <button id="manageStaplesBtn" class="btn">ç®¡ç†</button>
      </div>
    </div>
    <div id="stapleChips" class="chips"></div>
    <div class="hint" style="margin-top:6px;">é» + å¯æŠŠè©²é …ç›®åŠ å…¥ä»Šå¤©çš„æ¸…å–®ã€‚</div>
  </section>

  <section class="list" id="list"></section>
  <div class="empty" id="empty" style="display:none;">ç›®å‰æ²’æœ‰é …ç›®ï¼Œå…ˆä¸Šé¢æ–°å¢ä¸€å€‹å§ï¼</div>
</main>

<footer>è³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿï¼ˆé›¢ç·šå¯ç”¨ï¼‰ã€‚å®‰è£å¾Œæ›´åƒåŸç”Ÿ Appã€‚</footer>

<script>
/** ====== æœ¬åœ°è³‡æ–™å±¤ï¼ˆlocalStorageï¼‰====== **/
const KEY = 'memory_app_items_v1'; // [{id, title, note, imgData, checked, createdAt}]
const KEY_STAPLES = 'memory_app_staples_v1'; // [{id, title, note}]
let items = load(KEY, []);
let staples = load(KEY_STAPLES, [
  // é è¨­å¸¸è²·å¯æ”¹
  {id: crypto.randomUUID(), title:'ç‰›å¥¶', note:'å…¨è„‚ 2L'},
  {id: crypto.randomUUID(), title:'é›è›‹', note:'10å…¥'},
  {id: crypto.randomUUID(), title:'è¡›ç”Ÿç´™', note:'æŠ½å–å¼'}
]);

function load(k, fallback){ try{ return JSON.parse(localStorage.getItem(k)) || fallback }catch{ return fallback } }
function save(){ localStorage.setItem(KEY, JSON.stringify(items)); localStorage.setItem(KEY_STAPLES, JSON.stringify(staples)); }

/** ====== å·¥å…·ï¼šå£“ç¸®åœ–ç‰‡åˆ° base64ï¼ˆé•·é‚Š 800pxï¼‰====== **/
async function fileToDataURL(file, max=800, quality=0.72){
  if(!file) return null;
  const img = new Image();
  const reader = new FileReader();
  const data = await new Promise((res,rej)=>{
    reader.onload = () => res(reader.result);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });
  return await new Promise((res)=>{
    img.onload = ()=>{
      const w = img.width, h = img.height;
      let nw = w, nh = h;
      if (Math.max(w,h) > max){
        if (w >= h){ nw = max; nh = Math.round(h * (max/w)); }
        else { nh = max; nw = Math.round(w * (max/h)); }
      }
      const canvas = document.createElement('canvas');
      canvas.width = nw; canvas.height = nh;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, nw, nh);
      res(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = data;
  });
}

/** ====== DOM ====== **/
const $ = (q)=>document.querySelector(q);
const listEl = $('#list');
const emptyEl = $('#empty');
const searchEl = $('#search');
const stapleChipsEl = $('#stapleChips');

function renderStaples(){
  stapleChipsEl.innerHTML = '';
  if(staples.length===0){
    stapleChipsEl.innerHTML = '<span class="hint">ç›®å‰æ²’æœ‰å¸¸è²·é …ç›®ï¼Œå‹¾é¸ã€ŒåŒæ™‚å­˜åˆ°å¸¸è²·æ¸…å–®ã€å³å¯æ–°å¢ã€‚</span>';
    return;
  }
  staples.forEach(st=>{
    const chip = document.createElement('div');
    chip.className='chip';
    const b = document.createElement('b'); b.textContent = st.title;
    const small = document.createElement('span'); small.style.color='var(--muted)'; small.textContent = st.note? ` Â· ${st.note}` : '';
    const plus = document.createElement('button'); plus.className='plus'; plus.title='åŠ å…¥æ¸…å–®'; plus.textContent='+';
    plus.addEventListener('click', ()=>{
      items.unshift({ id: crypto.randomUUID(), title: st.title, note: st.note||'', imgData:null, checked:false, createdAt: Date.now() });
      save(); render();
    });
    chip.appendChild(b); chip.appendChild(small); chip.appendChild(plus);
    stapleChipsEl.appendChild(chip);
  });
}

function render(){
  renderStaples();
  listEl.innerHTML = '';
  const q = (searchEl.value || '').trim().toLowerCase();
  const filtered = items.filter(it=>{
    if(!q) return true;
    return (it.title||'').toLowerCase().includes(q) || (it.note||'').toLowerCase().includes(q);
  });

  emptyEl.style.display = filtered.length===0 ? 'block' : 'none';

  filtered
    .sort((a,b)=>Number(a.checked)-Number(b.checked) || b.createdAt - a.createdAt)
    .forEach(it=>{
      const card = document.createElement('div');
      card.className='card';

      const img = document.createElement('img');
      img.className='thumb'; img.alt = it.title || '';
      img.src = it.imgData || '';
      card.appendChild(img);

      const text = document.createElement('div');
      const title = document.createElement('p'); title.className='title'; title.textContent = it.title || '(æœªå‘½å)';
      const note = document.createElement('p'); note.className='note'; note.textContent = it.note || '';
      text.appendChild(title); text.appendChild(note);
      card.appendChild(text);

      const actions = document.createElement('div'); actions.className='actions';

      const lbl = document.createElement('label'); lbl.className='chk';
      const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!it.checked;
      chk.addEventListener('change',()=>{ it.checked = chk.checked; save(); render(); });
      const span = document.createElement('span'); span.textContent='å·²è²·';
      lbl.appendChild(chk); lbl.appendChild(span);

      const favBtn = document.createElement('button'); // è¨­ç‚ºå¸¸è²·
      favBtn.className='iconbtn'; favBtn.textContent='è¨­ç‚ºå¸¸è²·';
      favBtn.addEventListener('click', ()=>{
        if(!staples.some(s=>s.title===it.title && (s.note||'')===(it.note||''))){
          staples.unshift({id: crypto.randomUUID(), title: it.title, note: it.note||''});
          save(); renderStaples();
          alert('å·²åŠ å…¥å¸¸è²·æ¸…å–®');
        }else{
          alert('å¸¸è²·æ¸…å–®å·²å­˜åœ¨ç›¸åŒé …ç›®');
        }
      });

      const editBtn = document.createElement('button'); editBtn.className='iconbtn'; editBtn.title='ç·¨è¼¯'; editBtn.textContent='ç·¨è¼¯';
      editBtn.addEventListener('click', async ()=>{
        const newTitle = prompt('å“é …åç¨±', it.title || ''); if(newTitle===null) return;
        const newNote = prompt('å‚™è¨»', it.note || ''); it.title = newTitle.trim(); it.note = (newNote||'').trim(); save(); render();
      });

      const imgBtn = document.createElement('button'); imgBtn.className='iconbtn'; imgBtn.title='æ›´æ›ç…§ç‰‡'; imgBtn.textContent='ç…§ç‰‡';
      imgBtn.addEventListener('click', async ()=>{
        const input = document.createElement('input');
        input.type='file'; input.accept='image/*'; input.capture='environment';
        input.onchange = async ()=>{
          const file = input.files?.[0];
          it.imgData = file ? await fileToDataURL(file) : it.imgData;
          save(); render();
        };
        input.click();
      });

      const delBtn = document.createElement('button'); delBtn.className='iconbtn'; delBtn.title='åˆªé™¤'; delBtn.textContent='åˆªé™¤';
      delBtn.addEventListener('click',()=>{
        if(confirm('ç¢ºå®šåˆªé™¤é€™å€‹é …ç›®ï¼Ÿ')){
          items = items.filter(x=>x.id!==it.id);
          save(); render();
        }
      });

      actions.appendChild(lbl);
      actions.appendChild(favBtn);
      actions.appendChild(editBtn);
      actions.appendChild(imgBtn);
      actions.appendChild(delBtn);
      card.appendChild(actions);

      if(it.checked){ card.style.opacity=0.6; title.style.textDecoration='line-through'; }

      listEl.appendChild(card);
    });
}

$('#addForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const title = $('#title').value.trim();
  const note  = $('#note').value.trim();
  const file  = $('#photo').files[0];
  if(!title && !file){ alert('è‡³å°‘è¼¸å…¥åç¨±æˆ–é¸ä¸€å¼µç…§ç‰‡å”·ï¼'); return; }
  const imgData = file ? await fileToDataURL(file) : null;
  const it = { id: crypto.randomUUID(), title, note, imgData, checked:false, createdAt: Date.now() };
  items.unshift(it);

  if($('#saveAsStaple').checked && title){
    if(!staples.some(s=>s.title===title && (s.note||'')===(note||''))){
      staples.unshift({id: crypto.randomUUID(), title, note});
    }
  }

  save();
  $('#title').value=''; $('#note').value=''; $('#photo').value=''; $('#saveAsStaple').checked=false;
  render();
});

$('#addAllStaplesBtn').addEventListener('click', ()=>{
  if(staples.length===0){ alert('ç›®å‰æ²’æœ‰å¸¸è²·é …ç›®'); return; }
  staples.forEach(st=>{
    items.unshift({ id: crypto.randomUUID(), title: st.title, note: st.note||'', imgData:null, checked:false, createdAt: Date.now() });
  });
  save(); render(); alert('å·²å°‡å¸¸è²·é …ç›®åŠ å…¥æ¸…å–®');
});

$('#manageStaplesBtn').addEventListener('click', ()=>{
  if(staples.length===0){ alert('ç›®å‰æ²’æœ‰å¸¸è²·é …ç›®'); return; }
  const names = staples.map((s,i)=>`${i+1}. ${s.title}${s.note?`ï¼ˆ${s.note}ï¼‰`:''}`).join('\n');
  const idxStr = prompt(`è¼¸å…¥è¦åˆªé™¤çš„åºè™Ÿï¼ˆé€—è™Ÿå¯å¤šé¸ï¼Œä¾‹å¦‚ï¼š1,3ï¼‰\n\n${names}\n\nå–æ¶ˆ = ä¸æ“ä½œ`);
  if(idxStr===null || !idxStr.trim()) return;
  const indices = idxStr.split(',').map(s=>parseInt(s.trim(),10)-1).filter(n=>!isNaN(n));
  staples = staples.filter((_,i)=>!indices.includes(i));
  save(); renderStaples();
});

searchEl.addEventListener('input', render);

/** åŒ¯å‡º / åŒ¯å…¥ï¼ˆJSONï¼‰ **/
// å–ä»£ #exportBtn çš„ç›£è½å™¨ï¼ˆå®Œæ•´è²¼ä¸Šï¼‰
$('#exportBtn').addEventListener('click', async ()=>{
  const payload = { items, staples };
  const text = JSON.stringify(payload, null, 2);
  const bytes = new TextEncoder().encode(text);
  const blob  = new Blob([bytes], { type: 'application/json;charset=utf-8' });
  const file  = new File([blob], 'memory-data.json', { type: 'application/json' });

  // 1) å…ˆè©¦ iOS åˆ†äº«ï¼ˆèƒ½ç›´æ¥ã€Œå­˜åˆ°æª”æ¡ˆã€ï¼‰
  try{
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: 'è¨˜æ†¶å°æœ¬æœ¬å‚™ä»½',
        text: 'memory-data.jsonï¼ˆåœ¨åˆ†äº«å–®é¸ã€Œå­˜åˆ°æª”æ¡ˆã€ï¼‰'
      });
      return;
    }
  }catch(e){ /* å¿½ç•¥ï¼Œèµ°å‚™æ´ */ }

  // 2) åˆ†äº«ä¸è¡Œ â†’ ç›´æ¥å¦é–‹æ–°åˆ†é ï¼ˆæ­£ç¢º UTF-8ï¼‰ï¼Œå†ç”¨åˆ†äº«â†’å­˜åˆ°æª”æ¡ˆ
  try{
    const dataUrl = 'data:application/json;charset=utf-8,' + encodeURIComponent(text);
    window.open(dataUrl, '_blank');
    return;
  }catch(e){ /* å¿½ç•¥ï¼Œèµ°æœ€çµ‚å‚™æ´ */ }

  // 3) æœ€å¾Œå‚™æ´ï¼šä¸‹è¼‰ + å¯è¤‡è£½æ–‡å­—æ¡†
  try{
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'memory-data.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }catch(_){}
  prompt('è¤‡è£½ä»¥ä¸‹å…§å®¹ä¸¦å­˜æˆ memory-data.jsonï¼š', text);
});

// æ–°å¢ã€Œå‚™ä»½ï¼ˆè¤‡è£½ï¼‰ã€ï¼šä¸€éµå¯«å…¥å‰ªè²¼ç°¿ + é¡¯ç¤ºè¦–çª—
$('#copyBackupBtn').addEventListener('click', async ()=>{
  const payload = { items, staples };
  const text = JSON.stringify(payload, null, 2);
  try{
    await navigator.clipboard.writeText(text);
    alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹é–‹ã€Œæª”æ¡ˆ App â†’ æ–°å¢æ–‡å­—æª”ã€ï¼Œè²¼ä¸Šå¾Œå­˜æˆ memory-data.jsonã€‚');
  }catch(e){
    // æŸäº› iOS éœ€ä½¿ç”¨è€…æ‰‹å‹•è¤‡è£½
    prompt('ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•å…¨é¸è¤‡è£½ï¼š', text);
  }
});

$('#importBtn').addEventListener('click', ()=>{
  const input = document.createElement('input');
  input.type='file'; input.accept='application/json';
  input.onchange = async ()=>{
    const file = input.files?.[0]; if(!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      if(data && (Array.isArray(data.items) || Array.isArray(data.staples))){
        if(Array.isArray(data.items)) items = data.items;
        if(Array.isArray(data.staples)) staples = data.staples;
        save(); render();
      }else{ alert('æ ¼å¼ä¸æ­£ç¢º'); }
    }catch{ alert('ç„¡æ³•è§£ææª”æ¡ˆ'); }
  };
  input.click();
});

// åˆæ¬¡æ¸²æŸ“
render();
window.addEventListener('pageshow', ()=>render());

/** ====== PWA å®‰è£æµç¨‹ ====== **/
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt = e;
  const btn = document.getElementById('installBtn');
  btn.style.display='inline-block';
  btn.onclick = async ()=>{
    btn.style.display='none';
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
  };
});

// è¨»å†Š Service Worker
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js'); });
}
</script>
</body>
</html>