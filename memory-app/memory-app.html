<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>食譜 App • IndexedDB</title>
  <style>
    :root { --bg:#0f1115; --card:#161a22; --muted:#9aa4b2; --text:#e7eaf0; --accent:#62ffa2; --danger:#ff6b6b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, 'PingFang TC', 'Microsoft JhengHei', sans-serif; background:linear-gradient(180deg,#0e1014,#0b0d12 40%,#0f1115); color:var(--text); }
    header { position:sticky; top:0; z-index:10; backdrop-filter:saturate(160%) blur(8px); background:rgba(15,17,21,.6); border-bottom:1px solid #1f2430; }
    .bar { max-width:1000px; margin:0 auto; padding:12px 16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .brand { font-weight:700; letter-spacing:.3px; }
    input, textarea, button, select { font:inherit; color:var(--text); background:#0e1116; border:1px solid #2a3140; border-radius:10px; padding:10px 12px; }
    input::placeholder, textarea::placeholder { color:#6c7687; }
    button { background:#1a2130; cursor:pointer; }
    button.primary { background:linear-gradient(180deg,#1a3d2a,#132a1d); border:1px solid #264330; color:#d8ffe9; }
    button.ghost { background:transparent; border-color:#2a3140; }
    button.danger { background:#2a1518; border-color:#402126; color:#ffd9d9; }
    .pill { padding:8px 10px; border-radius:999px; border:1px solid #2a3140; background:#10141b; color:var(--muted); }
    main { max-width:1000px; margin:16px auto 80px; padding:0 16px; display:grid; grid-template-columns:1fr; gap:16px; }
    .grid { display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:900px){ main{grid-template-columns:360px 1fr;} }
    .card { background:var(--card); border:1px solid #222837; border-radius:16px; padding:14px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .grow { flex:1; }
    .right { margin-left:auto; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; }
    .tag { font-size:12px; padding:6px 8px; border-radius:999px; background:#0f1520; border:1px solid #2a3140; color:#b9c3d1; }
    .list { display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:640px){ .list{grid-template-columns:1fr 1fr;} }
    @media(min-width:1100px){ .list{grid-template-columns:1fr 1fr 1fr;} }
    .recipe { display:flex; flex-direction:column; gap:10px; padding:12px; border-radius:14px; background:#121722; border:1px solid #22293a; }
    .recipe h3 { margin:0; font-size:16px; }
    .meta { display:flex; gap:8px; align-items:center; color:#9aa4b2; font-size:12px; }
    .imgwrap { width:100%; aspect-ratio:4/3; background:#0b0f16; border:1px dashed #2a3140; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .imgwrap img { width:100%; height:100%; object-fit:cover; }
    .actions { display:flex; gap:8px; margin-top:auto; }
    .fav { color:#ffd27d; }
    .muted { color:var(--muted); }
    textarea { min-height:80px; }
    .hint { font-size:12px; color:#8e98a8; }
    .empty { text-align:center; color:#8e98a8; padding:24px 8px; border:1px dashed #2a3140; border-radius:12px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">🍳 食譜 App</div>
      <input id="q" class="grow" placeholder="搜尋：名稱、標籤、食材…" />
      <label class="pill"><input type="checkbox" id="onlyFav" /> 只看⭐</label>
      <button id="btnExport" class="ghost">匯出 JSON</button>
      <label class="ghost" style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        匯入 <input id="importFile" type="file" accept=".json" style="display:none;">
      </label>
      <button id="btnAdd" class="primary">＋ 新增食譜</button>
    </div>
  </header>

  <main>
    <!-- 編輯表單 -->
    <section class="card">
      <h2 style="margin:6px 0 10px;">新增 / 編輯</h2>
      <div class="grid">
        <input id="f_id" type="hidden">
        <input id="f_name" placeholder="食譜名稱（必填）*">
        <input id="f_tags" placeholder="標籤（以逗號分隔：家常, 快速, 低脂）">
        <textarea id="f_ingredients" placeholder="食材（每行一項）"></textarea>
        <textarea id="f_steps" placeholder="步驟（每行一步）"></textarea>
        <div class="row">
          <input id="f_image" type="file" accept="image/*" class="grow">
          <label class="pill"><input type="checkbox" id="f_fav"> 加到⭐最愛</label>
          <button id="btnSave" class="primary right">儲存</button>
          <button id="btnReset" class="ghost">清空</button>
        </div>
        <div class="imgwrap" id="preview">
          <span class="muted">預覽區（可不放圖）</span>
        </div>
        <div class="hint">提示：圖片會以 base64 存在 IndexedDB。若想改用 Blob 更省空間，請看程式內註解。</div>
      </div>
    </section>

    <!-- 列表 -->
    <section class="card">
      <div class="row" style="margin-bottom:8px;">
        <h2 class="grow" style="margin:6px 0 0;">我的食譜</h2>
        <span id="count" class="muted">0 筆</span>
      </div>
      <div id="list" class="list"></div>
      <div id="empty" class="empty" style="display:none;">目前尚無食譜，先在左側新增一筆吧！</div>
    </section>
  </main>

  <template id="tpl-card">
    <article class="recipe">
      <div class="imgwrap"><img alt=""></div>
      <h3></h3>
      <div class="meta"><span class="fav" style="display:none;">⭐</span><span class="muted"></span></div>
      <div class="tags"></div>
      <div class="actions">
        <button class="ghost btnEdit">編輯</button>
        <button class="danger btnDel">刪除</button>
        <button class="ghost btnFav">切換⭐</button>
      </div>
    </article>
  </template>

  <script>
    // ======== IndexedDB 基礎設定 ========
    const DB_NAME = 'recipes-db';
    const DB_VERSION = 1;
    const STORE = 'recipes';
    let db;

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE)) {
            const store = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
            store.createIndex('name', 'name', { unique: false });
            store.createIndex('tags', 'tags', { unique: false, multiEntry: true });
            store.createIndex('fav', 'fav', { unique: false });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function tx(storeName, mode='readonly') {
      const t = db.transaction(storeName, mode);
      return t.objectStore(storeName);
    }

    function addRecipe(data) {
      return new Promise((res, rej)=> {
        const r = tx(STORE, 'readwrite').add(data);
        r.onsuccess = () => res(r.result);
        r.onerror = () => rej(r.error);
      });
    }
    function updateRecipe(data) {
      return new Promise((res, rej)=> {
        const r = tx(STORE, 'readwrite').put(data);
        r.onsuccess = () => res(r.result);
        r.onerror = () => rej(r.error);
      });
    }
    function deleteRecipe(id) {
      return new Promise((res, rej)=> {
        const r = tx(STORE, 'readwrite').delete(id);
        r.onsuccess = () => res();
        r.onerror = () => rej(r.error);
      });
    }
    function getAllRecipes() {
      return new Promise((res, rej)=> {
        const r = tx(STORE).getAll();
        r.onsuccess = () => res(r.result);
        r.onerror = () => rej(r.error);
      });
    }

    // ======== UI 狀態 ========
    const el = (id)=>document.getElementById(id);
    const f = {
      id: el('f_id'),
      name: el('f_name'),
      tags: el('f_tags'),
      ingredients: el('f_ingredients'),
      steps: el('f_steps'),
      image: el('f_image'),
      fav: el('f_fav'),
      preview: el('preview'),
    };
    const listEl = el('list');
    const emptyEl = el('empty');
    const countEl = el('count');
    const searchEl = el('q');
    const onlyFavEl = el('onlyFav');
    const importFileEl = el('importFile');

    function resetForm() {
      f.id.value = '';
      f.name.value = '';
      f.tags.value = '';
      f.ingredients.value = '';
      f.steps.value = '';
      f.image.value = '';
      f.fav.checked = false;
      f.preview.innerHTML = '<span class="muted">預覽區（可不放圖）</span>';
      f.preview.dataset.dataurl = '';
    }

    function readImageAsDataURL(file) {
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }

    // 若要改存 Blob（更省空間），可用以下兩行替代上方：
    // function readImageAsBlob(file) { return Promise.resolve(file); }
    // 並將資料欄位 imageDataUrl 改為 imageBlob，存取時用 URL.createObjectURL()

    f.image.addEventListener('change', async () => {
      const file = f.image.files?.[0];
      if (!file) return;
      const dataUrl = await readImageAsDataURL(file);
      f.preview.innerHTML = `<img alt="預覽">`;
      f.preview.querySelector('img').src = dataUrl;
      f.preview.dataset.dataurl = dataUrl;
    });

    // ======== Render 列表 ========
    let cache = []; // 方便搜尋/篩選

    function render() {
      const q = searchEl.value.trim().toLowerCase();
      const favOnly = onlyFavEl.checked;
      const filtered = cache.filter(r => {
        if (favOnly && !r.fav) return false;
        if (!q) return true;
        const hay = [
          r.name,
          (r.tags||[]).join(' '),
          (r.ingredients||''),
          (r.steps||'')
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });

      listEl.innerHTML = '';
      countEl.textContent = `${filtered.length} 筆`;
      emptyEl.style.display = filtered.length ? 'none' : 'block';

      const tpl = document.getElementById('tpl-card');
      filtered.forEach(r => {
        const node = tpl.content.cloneNode(true);
        const art = node.querySelector('.recipe');
        const img = node.querySelector('img');
        const title = node.querySelector('h3');
        const meta = node.querySelector('.meta .muted');
        const fav = node.querySelector('.fav');
        const tags = node.querySelector('.tags');
        const btnEdit = node.querySelector('.btnEdit');
        const btnDel = node.querySelector('.btnDel');
        const btnFav = node.querySelector('.btnFav');

        title.textContent = r.name || '(未命名)';
        meta.textContent = (r.ingredients||'').split('\n').filter(Boolean).slice(0,3).join(' • ');
        fav.style.display = r.fav ? 'inline' : 'none';

        if (r.imageDataUrl) {
          img.src = r.imageDataUrl;
        } else {
          img.replaceWith(document.createElement('div')); // 保留框
        }

        (r.tags||[]).forEach(t=>{
          const s = document.createElement('span');
          s.className = 'tag';
          s.textContent = t;
          tags.appendChild(s);
        });

        btnEdit.onclick = () => fillForm(r);
        btnDel.onclick = async () => {
          if (confirm(`刪除「${r.name}」？`)) {
            await deleteRecipe(r.id);
            await refresh();
          }
        };
        btnFav.onclick = async () => {
          r.fav = !r.fav;
          await updateRecipe(r);
          await refresh();
        };

        listEl.appendChild(node);
      });
    }

    function fillForm(r) {
      f.id.value = r.id;
      f.name.value = r.name || '';
      f.tags.value = (r.tags||[]).join(', ');
      f.ingredients.value = r.ingredients || '';
      f.steps.value = r.steps || '';
      f.fav.checked = !!r.fav;
      if (r.imageDataUrl) {
        f.preview.innerHTML = `<img alt="預覽">`;
        f.preview.querySelector('img').src = r.imageDataUrl;
        f.preview.dataset.dataurl = r.imageDataUrl;
      } else {
        f.preview.innerHTML = '<span class="muted">預覽區（可不放圖）</span>';
        f.preview.dataset.dataurl = '';
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function refresh() {
      cache = await getAllRecipes();
      // 依更新時間排序（新→舊）
      cache.sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
      render();
    }

    // ======== 事件綁定 ========
    document.getElementById('btnSave').addEventListener('click', async ()=>{
      const id = Number(f.id.value) || null;
      const name = f.name.value.trim();
      if (!name) { alert('請輸入食譜名稱'); return; }
      const tags = f.tags.value.split(',').map(s=>s.trim()).filter(Boolean);
      const ingredients = f.ingredients.value.trim();
      const steps = f.steps.value.trim();
      const fav = f.fav.checked;
      const imageDataUrl = f.preview.dataset.dataurl || '';

      const data = {
        id: id || undefined,
        name, tags, ingredients, steps, fav, imageDataUrl,
        updatedAt: Date.now()
      };

      if (id) await updateRecipe(data);
      else await addRecipe(data);

      await refresh();
      resetForm();
    });

    document.getElementById('btnReset').addEventListener('click', resetForm);
    document.getElementById('btnAdd').addEventListener('click', resetForm);
    document.getElementById('btnExport').addEventListener('click', async ()=>{
      const all = await getAllRecipes();
      const blob = new Blob([JSON.stringify({version:1, items:all}, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `recipes-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    importFileEl.addEventListener('change', async ()=>{
      const file = importFileEl.files?.[0];
      if (!file) return;
      const text = await file.text();
      try {
        const parsed = JSON.parse(text);
        const items = parsed.items || [];
        if (!Array.isArray(items)) throw new Error('格式錯誤');
        if (!items.length) { alert('沒有可匯入的資料'); return; }
        const store = tx(STORE, 'readwrite');
        await new Promise((res,rej)=>{
          const clearReq = store.clear();
          clearReq.onsuccess = res; clearReq.onerror = ()=>rej(clearReq.error);
        });
        for (const it of items) {
          delete it.id; // 重新給新 id，避免衝突
          await new Promise((res,rej)=>{
            const r = store.add(it);
            r.onsuccess = res; r.onerror = ()=>rej(r.error);
          });
        }
        await refresh();
        alert(`已匯入 ${items.length} 筆`);
      } catch (e) {
        alert('匯入失敗：' + e.message);
      } finally {
        importFileEl.value = '';
      }
    });

    searchEl.addEventListener('input', render);
    onlyFavEl.addEventListener('change', render);

    // ======== 啟動 ========
    (async function init(){
      db = await openDB();
      await refresh();
    })();
  </script>
</body>
</html>