<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>籃球計分板</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header>
    <div class="container row space-between">
      <h1>🏀 籃球計分板</h1>
      <div class="row">
        <button id="btnExport" class="btn">匯出 TXT</button>
        <button id="btnExportCSV" class="btn">匯出 CSV</button>
        <button id="btnExportJSON" class="btn">匯出 JSON</button>
        <button id="btnUpdate" class="btn-accent">更新（覆寫同檔）</button>
        <button id="btnReset" class="btn-danger">清空本場</button>
      </div>
    </div>
    <div class="container tabs-wrap">
      <div class="tabs">
        <button class="tab active" data-view="scoreView">計分板</button>
        <button class="tab" data-view="playersView">球員索引</button>
        <button class="tab" data-view="playerAdminView">球員管理</button>
        <button class="tab" data-view="rulesView">規則設定</button>
      </div>
    </div>
  </header>

  <main class="container main">
    <!-- 計分板 View -->
    <div id="scoreView" class="view active">
      <div class="grid grid-3">
        <!-- Scoreboard + Team Fouls -->
        <section class="card">
          <div class="row space-between">
            <div>
              <div class="label">主隊</div>
              <div class="score" id="homeScore">0</div>
              <div class="row">
                <button data-add="home:1">+1</button>
                <button data-add="home:2">+2</button>
                <button data-add="home:3">+3</button>
                <button data-add="home:-1">-1</button>
              </div>
              <div class="row mt8 center">
                <span class="label">團隊犯規</span>
                <span id="homeFouls" class="foul-count">0</span>
                <span id="homeBonus" class="bonus" style="display:none">Bonus</span>
              </div>
              <div class="row">
                <button data-tf="home:-1">-</button>
                <button data-tf="home:1" class="btn-warn">+ 犯規</button>
                <button id="homeFoulsReset">本節清零</button>
              </div>
            </div>

            <div>
              <div class="label">客隊</div>
              <div class="score" id="awayScore">0</div>
              <div class="row">
                <button data-add="away:1">+1</button>
                <button data-add="away:2">+2</button>
                <button data-add="away:3">+3</button>
                <button data-add="away:-1">-1</button>
              </div>
              <div class="row mt8 center">
                <span class="label">團隊犯規</span>
                <span id="awayFouls" class="foul-count">0</span>
                <span id="awayBonus" class="bonus" style="display:none">Bonus</span>
              </div>
              <div class="row">
                <button data-tf="away:-1">-</button>
                <button data-tf="away:1" class="btn-warn">+ 犯規</button>
                <button id="awayFoulsReset">本節清零</button>
              </div>
            </div>
          </div>

          <hr class="divider" />
          <div class="grid grid-2">
            <div class="row">
              <div class="flex1">
                <div class="label">節次</div>
                <div class="row">
                  <button id="periodDec">-</button>
                  <div id="period" class="score small">第1節</div>
                  <button id="periodInc">+</button>
                </div>
              </div>
              <div class="flex1">
                <div class="label">比賽資訊</div>
                <input id="gameTitle" placeholder="比賽名稱（例：聯賽A：主隊 vs 客隊）" />
              </div>
            </div>
          </div>
        </section>

        <!-- Game Clock -->
        <section class="card">
          <div class="row space-between">
            <div class="label">比賽計時（Game Clock）</div>
            <span class="chip">OT 自動 5:00；到 0 自動下一節</span>
          </div>
          <div class="game-face">
            <div id="gameDisplay" class="game-display">12:00</div>
            <div id="gameInfo" class="muted">長度：12:00</div>
          </div>
          <div class="row center">
            <button id="gameStart" class="btn-accent">開始</button>
            <button id="gamePause">暫停</button>
            <button id="gameReset">重置本節</button>
            <button id="set12">12:00</button>
            <button id="set10">10:00</button>
            <button id="set5">5:00</button>
            <button id="toggleLink">與 24s 連動：關</button>
          </div>
        </section>

        <!-- Shot Clock + 事件面板 -->
        <section class="card">
          <div class="row space-between">
            <div class="label">進攻時計（24s / 14s）</div>
            <span class="chip">≤8 秒顯示到 0.01；到 0 自動違例</span>
          </div>
          <div class="shot-face">
            <div id="shotDisplay" class="shot-display">24</div>
            <div id="shotPos" class="muted">球權：主隊</div>
          </div>
          <div class="row center">
            <button id="shotStart" class="btn-accent">開始</button>
            <button id="shotPause">暫停</button>
            <button id="shotReset24">重置 24</button>
            <button id="shotReset14">重置 14</button>
            <button id="shotMinus">-1s</button>
            <button id="shotPlus">+1s</button>
            <button id="shotSwap">切換球權</button>
            <button id="shotViolation" class="btn-danger">判 24 秒違例</button>
          </div>

          <hr class="divider">
          <div class="label">快速情境</div>
          <div class="row">
            <button id="qaOffReb14" title="進攻籃板後重置 14 秒">進攻籃板（14s）</button>
            <button id="qaChangePoss24" title="防守籃板或失誤等換球權重置 24 秒">換球權（24s）</button>
          </div>

          <hr class="divider">
          <div class="label">犯規 / 事件面板（選隊伍＋背號後點事件）</div>
          <div class="row">
            <select id="evtTeam">
              <option value="home">主隊</option>
              <option value="away">客隊</option>
            </select>
            <input id="evtNum" type="number" placeholder="背號" style="width:110px" />
          </div>
          <div class="opset mt8">
            <button id="evDefCommon" class="opbtn btn-warn">防守犯規 → 對方兩罰</button>
            <button id="evOffensive" class="opbtn btn-warn">進攻犯規（控球）</button>
            <button id="evShoot2" class="opbtn btn-warn">投籃犯規（2罰）</button>
            <button id="evShoot3" class="opbtn btn-warn">投籃犯規（3罰）</button>
            <button id="evAnd1" class="opbtn btn-warn">And-1（投籃成球）</button>
            <button id="evTechnical" class="opbtn btn-warn">技術犯規（T）</button>
            <button id="evUnsports" class="opbtn btn-warn">違體犯規（U）</button>
          </div>

          <div class="label mt12">備註（可寫入TXT/CSV/JSON）</div>
          <textarea id="notes" rows="6" placeholder="例：第三節 05:22 主隊 10:0 攻勢，#7 三分追平"></textarea>
        </section>
      </div>
    </div>

    <!-- 球員索引（比賽中 box score 快速面板） -->
    <div id="playersView" class="view">
      <section class="card">
        <div class="row space-between">
          <div class="label">球員索引 / 新增球員</div>
          <span class="chip">犯(總)到上限自動標紅；T/U 到上限標記退場；勾選「上場」會累計上場時間</span>
        </div>
        <div class="grid grid-2 mt8">
          <input id="pNum" type="number" placeholder="背號（數字）"/>
          <input id="pName" placeholder="姓名"/>
          <select id="pTeam">
            <option value="home">主隊</option>
            <option value="away">客隊</option>
          </select>
          <input id="pPos" placeholder="位置（G/F/C）"/>
        </div>
        <div class="row mt8">
          <button id="addPlayer" class="btn-accent">加入名單</button>
          <span class="muted">重複背號會覆蓋該隊同背號。</span>
        </div>

        <div class="table-wrap">
          <table id="playersTbl">
            <thead>
              <tr>
                <th>隊伍</th><th>背號</th><th>姓名</th><th>位置</th>
                <th>分</th><th>犯(總)</th><th>進攻</th><th>技</th><th>違體</th>
                <th>助</th><th>板</th><th>抄</th><th>阻</th><th>失</th>
                <th>上場</th><th>MIN</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody><!-- rows --></tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- 新增：球員管理（高階資料登入/批量管理） -->
    <div id="playerAdminView" class="view">
      <section class="card">
        <div class="row space-between">
          <div class="label">球員管理（高階資料登入）</div>
          <div class="row">
            <button id="btnBulkImport" class="btn">批量匯入</button>
            <button id="btnBulkExport" class="btn">匯出名單 CSV</button>
            <button id="btnClearRoster" class="btn-danger">清空名單</button>
          </div>
        </div>

        <!-- 單筆新增/編輯表單 -->
        <div class="grid grid-3 mt12">
          <div class="card">
            <div class="label">基本資料</div>
            <div class="grid grid-2 mt8">
              <label>隊伍
                <select id="fmTeam">
                  <option value="home">主隊</option>
                  <option value="away">客隊</option>
                </select>
              </label>
              <label>背號
                <input id="fmNumber" type="number" min="0" placeholder="例：7" />
              </label>
              <label>姓名（中文）
                <input id="fmNameZh" placeholder="例：王小明" />
              </label>
              <label>姓名（英文）
                <input id="fmNameEn" placeholder="例：Ming Wang" />
              </label>
              <label>位置
                <select id="fmPos">
                  <option>PG</option><option>SG</option><option>SF</option><option>PF</option><option>C</option>
                </select>
              </label>
              <label>場上角色
                <select id="fmRole">
                  <option value="starter">先發</option>
                  <option value="bench">替補</option>
                </select>
              </label>
            </div>

            <div class="grid grid-2 mt8">
              <label>身高（cm）
                <input id="fmHeight" type="number" min="120" max="250" placeholder="例：188" />
              </label>
              <label>體重（kg）
                <input id="fmWeight" type="number" min="40" max="160" placeholder="例：85" />
              </label>
              <label>生日
                <input id="fmDob" type="date" />
              </label>
              <label>國籍
                <input id="fmNationality" placeholder="例：TW / USA" />
              </label>
            </div>
          </div>

          <div class="card">
            <div class="label">比賽屬性 / 偏好</div>
            <div class="grid grid-2 mt8">
              <label>慣用手
                <select id="fmHand">
                  <option value="R">右手</option>
                  <option value="L">左手</option>
                </select>
              </label>
              <label>外線定位
                <select id="fmArc">
                  <option value="">—</option>
                  <option value="3&D">3&D</option>
                  <option value="Sharpshooter">純射手</option>
                  <option value="Slasher">切入型</option>
                  <option value="Point Forward">控球前鋒</option>
                </select>
              </label>
              <label>背號外觀（可選）
                <input id="fmNumberStyle" placeholder="例：NBA Block, College, ..."/>
              </label>
              <label>聯盟/學號/官方ID
                <input id="fmRegId" placeholder="例：CIBL-2025-007" />
              </label>
            </div>

            <div class="grid grid-2 mt8">
              <label>Email（管理用）
                <input id="fmEmail" type="email" placeholder="player@example.com" />
              </label>
              <label>電話（管理用）
                <input id="fmPhone" type="tel" placeholder="09xx-xxx-xxx" />
              </label>
            </div>
          </div>

          <div class="card">
            <div class="label">頭像 / 其他</div>
            <div class="row mt8">
              <div class="avatar-wrap">
                <img id="fmAvatarPreview" alt="頭像預覽" style="width:120px;height:120px;border-radius:12px;object-fit:cover;border:1px solid var(--line);" />
              </div>
              <div class="grid" style="min-width:220px;">
                <input id="fmAvatar" type="file" accept="image/*" />
                <input id="fmAvatarUrl" placeholder="或貼上圖片 URL" />
              </div>
            </div>
            <div class="row mt12">
              <button id="btnSavePlayer" class="btn-accent">儲存 / 更新</button>
              <button id="btnResetForm" class="btn">清空表單</button>
              <span class="muted">同隊同背號會覆蓋（更新）。</span>
            </div>
          </div>
        </div>

        <!-- 名單檢視 / 編輯 -->
        <div class="card mt12">
          <div class="row space-between">
            <div class="label">名單總覽（可快速編輯）</div>
            <div class="row">
              <label class="row"><span class="label">顯示：</span>
                <select id="filterTeam">
                  <option value="all">全部</option>
                  <option value="home">主隊</option>
                  <option value="away">客隊</option>
                </select>
              </label>
              <input id="filterKeyword" placeholder="搜尋姓名/背號/位置…" />
            </div>
          </div>

          <div class="table-wrap">
            <table id="rosterTbl">
              <thead>
                <tr>
                  <th>隊伍</th><th>背號</th><th>中文名</th><th>英文名</th><th>位置</th>
                  <th>身高</th><th>體重</th><th>生日</th><th>國籍</th>
                  <th>角色</th><th>慣手</th><th>官方ID</th><th>聯絡</th>
                  <th>頭像</th><th>操作</th>
                </tr>
              </thead>
              <tbody><!-- rows --></tbody>
            </table>
          </div>
        </div>

        <!-- 批量匯入 Modal（CSV / 貼上） -->
        <div id="bulkModal" class="modal" style="display:none">
          <div class="modal-box">
            <div class="row space-between">
              <div class="label">批量匯入球員</div>
              <button id="bulkClose">✕</button>
            </div>
            <div class="mt8">
              <div class="muted">支援 CSV 欄位（可少可多）：team,number,nameZh,nameEn,pos,height,weight,dob,nationality,role,hand,regId,email,phone,avatarUrl</div>
              <textarea id="bulkPaste" rows="8" placeholder="貼上 CSV 內容或以逗號分隔的多列資料"></textarea>
              <div class="row mt8">
                <input id="bulkFile" type="file" accept=".csv,text/csv,text/plain" />
                <button id="bulkParse" class="btn-accent">解析預覽</button>
              </div>
            </div>
            <div class="table-wrap mt12">
              <table id="bulkPreviewTbl">
                <thead><tr id="bulkHeadRow"></tr></thead>
                <tbody id="bulkBody"></tbody>
              </table>
            </div>
            <div class="row center mt12">
              <button id="bulkConfirm" class="btn-accent">寫入名單</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- 規則設定 + 裁判 -->
    <div id="rulesView" class="view">
      <section class="card">
        <div class="label">犯規計數規則（哪些算入團隊犯規）</div>
        <div class="grid grid-2 mt12">
          <label><input type="checkbox" id="ruleCountCommon" checked> 一般犯規 計入團隊</label>
          <label><input type="checkbox" id="ruleCountOffensive"> 進攻犯規 計入團隊</label>
          <label><input type="checkbox" id="ruleCountTechnical"> 技術犯規 計入團隊</label>
          <label><input type="checkbox" id="ruleCountUnsportsmanlike" checked> 違體犯規 計入團隊</label>
        </div>

        <hr class="divider">
        <div class="label">上限 & 退場條件</div>
        <div class="grid grid-2 mt12">
          <label>個人犯規上限（PF）<input id="limitPF" type="number" min="1" max="6" value="5" /></label>
          <label>技術犯規上限（T）<input id="limitT" type="number" min="1" max="3" value="2" /></label>
          <label>違體犯規上限（U）<input id="limitU" type="number" min="1" max="3" value="2" /></label>
        </div>
        <div class="row mt12">
          <button id="presetFIBA">FIBA 預設</button>
          <button id="presetNBA">NBA 預設</button>
          <span class="muted">（勾選與上限可依賽制微調）</span>
        </div>

        <hr class="divider">
        <div class="label">裁判資訊（本場執行裁判）</div>
        <div class="grid grid-2 mt12">
          <label>裁判長（Crew Chief）
            <input id="refCrew" placeholder="例：王小明" />
          </label>
          <label>第一副審（Umpire 1）
            <input id="refU1" placeholder="例：李大華" />
          </label>
          <label>第二副審（Umpire 2）
            <input id="refU2" placeholder="例：陳小美" />
          </label>
        </div>
      </section>
    </div>
  </main>

  <!-- 罰球引導器 Modal -->
  <div id="ftModal" class="modal" style="display:none">
    <div class="modal-box">
      <div class="row space-between">
        <div class="label">罰球引導器</div>
        <button id="ftClose">✕</button>
      </div>
      <div id="ftInfo" class="mt8 muted"></div>
      <div id="ftShots" class="ft-shots mt12"><!-- FT buttons --></div>
      <div class="row mt12 center">
        <button id="ftReset" class="btn">重置本次</button>
        <button id="ftDone" class="btn-accent">完成</button>
      </div>
    </div>
  </div>

  <script src="./app.js"></script>
</body>
</html>