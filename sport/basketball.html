<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç±ƒçƒè¨ˆåˆ†æ¿ï¼ˆFIBAçŠ¯è¦äº‹ä»¶ï¼‹Fouled Outï¼‰</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --accent:#22c55e; --danger:#ef4444; --fg:#e5e7eb; --line:#1f2937; --warn:#f59e0b; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    header{position:sticky;top:0;background:rgba(15,23,42,.85);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;gap:16px}
    @media (min-width:1000px){ .grid-3{grid-template-columns:1.1fr 1.1fr 0.9fr} .grid-2{grid-template-columns:1fr 1fr} }
    .card{background:linear-gradient(180deg,#0b1224,#0b1224) padding-box, radial-gradient(120% 120% at 100% 0%, #1e293b, transparent 40%) border-box;border:1px solid var(--line);border-radius:14px;padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .score{font-size:44px;font-weight:800;letter-spacing:1px}
    .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    button,.btn{appearance:none;border:1px solid var(--line);background:#0b1224;color:var(--fg);padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{border-color:#334155}
    .btn-accent{background:var(--accent);border-color:transparent;color:#04120a}
    .btn-danger{background:var(--danger);border-color:transparent;color:#fff}
    .btn-warn{background:var(--warn);border-color:transparent;color:#04120a}
    input,select,textarea{background:#0b1224;border:1px solid var(--line);color:#fff;padding:10px;border-radius:10px;width:100%}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .chip{font-size:12px;color:#a7f3d0;background:#064e3b;padding:3px 8px;border-radius:9999px;border:1px solid #0f766e}
    .muted{color:var(--muted)}
    .shot-face{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:8px 0}
    .shot-display{font:900 64px/1 ui-monospace,Menlo,Consolas,monospace;letter-spacing:1px}
    .shot-danger{color:#fecaca}
    .game-face{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:8px 0}
    .game-display{font:900 56px/1 ui-monospace,Menlo,Consolas,monospace;letter-spacing:1px}
    .game-danger{color:#fde68a}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0b1224;cursor:pointer}
    .tab.active{background:#1f2937}
    .view{display:none}
    .view.active{display:block}
    .bonus{padding:2px 8px;border-radius:999px;background:#451a03;color:#ffedd5;border:1px solid #78350f;font-size:12px}
    .foul-count{font:700 24px/1 ui-monospace,Menlo,Consolas,monospace}
    .opbtn{font-size:12px;padding:4px 8px;border-radius:8px}
    .fouledout{background:#3f1d1d}
    .tag{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #334155;color:#cbd5e1}
  </style>
</head>
<body>
  <header>
    <div class="container row" style="justify-content:space-between">
      <h1>ğŸ€ ç±ƒçƒè¨ˆåˆ†æ¿</h1>
      <div class="row">
        <button id="btnExport" class="btn">åŒ¯å‡º TXT</button>
        <button id="btnUpdate" class="btn-accent">æ›´æ–°ï¼ˆè¦†å¯«åŒæª”ï¼‰</button>
        <button id="btnReset" class="btn-danger">æ¸…ç©ºæœ¬å ´</button>
      </div>
    </div>
    <div class="container" style="padding-top:0">
      <div class="tabs">
        <button class="tab active" data-view="scoreView">è¨ˆåˆ†æ¿</button>
        <button class="tab" data-view="playersView">çƒå“¡ç´¢å¼•</button>
      </div>
    </div>
  </header>

  <main class="container" style="margin-top:12px">
    <!-- è¨ˆåˆ†æ¿ View -->
    <div id="scoreView" class="view active">
      <div class="grid grid-3">
        <!-- Scoreboard + Team Fouls -->
        <section class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="label">ä¸»éšŠ</div>
              <div class="score" id="homeScore">0</div>
              <div class="row">
                <button data-add="home:1">+1</button>
                <button data-add="home:2">+2</button>
                <button data-add="home:3">+3</button>
                <button data-add="home:-1">-1</button>
              </div>
              <div class="row" style="margin-top:8px;align-items:center">
                <span class="label">åœ˜éšŠçŠ¯è¦</span>
                <span id="homeFouls" class="foul-count">0</span>
                <span id="homeBonus" class="bonus" style="display:none">Bonus</span>
              </div>
              <div class="row">
                <button data-tf="home:-1">-</button>
                <button data-tf="home:1" class="btn-warn">+ çŠ¯è¦</button>
                <button id="homeFoulsReset">æœ¬ç¯€æ¸…é›¶</button>
              </div>
            </div>

            <div>
              <div class="label">å®¢éšŠ</div>
              <div class="score" id="awayScore">0</div>
              <div class="row">
                <button data-add="away:1">+1</button>
                <button data-add="away:2">+2</button>
                <button data-add="away:3">+3</button>
                <button data-add="away:-1">-1</button>
              </div>
              <div class="row" style="margin-top:8px;align-items:center">
                <span class="label">åœ˜éšŠçŠ¯è¦</span>
                <span id="awayFouls" class="foul-count">0</span>
                <span id="awayBonus" class="bonus" style="display:none">Bonus</span>
              </div>
              <div class="row">
                <button data-tf="away:-1">-</button>
                <button data-tf="away:1" class="btn-warn">+ çŠ¯è¦</button>
                <button id="awayFoulsReset">æœ¬ç¯€æ¸…é›¶</button>
              </div>
            </div>
          </div>

          <hr style="border:0;border-top:1px solid var(--line);margin:16px 0" />
          <div class="grid grid-2">
            <div class="row">
              <div style="flex:1">
                <div class="label">ç¯€æ¬¡</div>
                <div class="row">
                  <button id="periodDec">-</button>
                  <div id="period" class="score" style="font-size:28px">ç¬¬1ç¯€</div>
                  <button id="periodInc">+</button>
                </div>
              </div>
              <div style="flex:1">
                <div class="label">æ¯”è³½è³‡è¨Š</div>
                <input id="gameTitle" placeholder="æ¯”è³½åç¨±ï¼ˆä¾‹ï¼šè¯è³½Aï¼šä¸»éšŠ vs å®¢éšŠï¼‰" />
              </div>
            </div>
          </div>
        </section>

        <!-- Game Clock -->
        <section class="card">
          <div class="row" style="justify-content:space-between">
            <div class="label">æ¯”è³½è¨ˆæ™‚ï¼ˆGame Clockï¼‰</div>
            <span class="chip">OT è‡ªå‹• 5:00ï¼›åˆ° 0 è‡ªå‹•ä¸‹ä¸€ç¯€</span>
          </div>
          <div class="game-face">
            <div id="gameDisplay" class="game-display">12:00</div>
            <div id="gameInfo" class="muted">é•·åº¦ï¼š12:00</div>
          </div>
          <div class="row" style="justify-content:center">
            <button id="gameStart" class="btn-accent">é–‹å§‹</button>
            <button id="gamePause">æš«åœ</button>
            <button id="gameReset">é‡ç½®æœ¬ç¯€</button>
            <button id="set12">12:00</button>
            <button id="set10">10:00</button>
            <button id="set5">5:00</button>
            <button id="toggleLink">èˆ‡ 24s é€£å‹•ï¼šé—œ</button>
          </div>
        </section>

        <!-- Shot Clock & Quick actions -->
        <section class="card">
          <div class="row" style="justify-content:space-between">
            <div class="label">é€²æ”»æ™‚è¨ˆï¼ˆ24s / 14sï¼‰</div>
            <span class="chip">â‰¤8 ç§’é¡¯ç¤ºåˆ° 0.01ï¼›åˆ° 0 è‡ªå‹•é•ä¾‹</span>
          </div>
          <div class="shot-face">
            <div id="shotDisplay" class="shot-display">24</div>
            <div id="shotPos" class="muted">çƒæ¬Šï¼šä¸»éšŠ</div>
          </div>
          <div class="row" style="justify-content:center">
            <button id="shotStart" class="btn-accent">é–‹å§‹</button>
            <button id="shotPause">æš«åœ</button>
            <button id="shotReset24">é‡ç½® 24</button>
            <button id="shotReset14">é‡ç½® 14</button>
            <button id="shotMinus">-1s</button>
            <button id="shotPlus">+1s</button>
            <button id="shotSwap">åˆ‡æ›çƒæ¬Š</button>
            <button id="shotViolation" class="btn-danger">åˆ¤ 24 ç§’é•ä¾‹</button>
          </div>
          <hr style="border:0;border-top:1px solid var(--line);margin:12px 0">

          <!-- FIBA çŠ¯è¦äº‹ä»¶ -->
          <div class="label">çŠ¯è¦äº‹ä»¶ï¼ˆFIBAï¼‰</div>
          <div class="row" style="align-items:center">
            <select id="foulPlayer"></select>
            <span class="tag" id="foulPlayerInfo"></span>
          </div>
          <div class="row" style="margin-top:6px">
            <button class="btn-warn" id="btnDefFoul">é˜²å®ˆçŠ¯è¦ï¼ˆéæŠ•ç±ƒï¼‰</button>
            <button class="btn-warn" id="btnOffFoul">é€²æ”»çŠ¯è¦ï¼ˆç„¡ç½°ï¼‰</button>
            <button class="btn-warn" id="btnShoot2">æŠ•ç±ƒçŠ¯è¦ 2 åˆ†ï¼ˆæœªä¸­ï¼‰</button>
            <button class="btn-warn" id="btnShoot3">æŠ•ç±ƒçŠ¯è¦ 3 åˆ†ï¼ˆæœªä¸­ï¼‰</button>
            <button class="btn" id="btnTech">æŠ€è¡“çŠ¯è¦ï¼ˆ1 ç½°ï¼Œçƒæ¬Šä¸è®Šï¼‰</button>
            <button class="btn-danger" id="btnUnsport">éé«”è‚²é“å¾·ï¼ˆ2 ç½° + çƒæ¬Šï¼‰</button>
          </div>

          <div class="label" style="margin-top:12px">å‚™è¨»ï¼ˆå¯å¯«å…¥TXTï¼‰</div>
          <textarea id="notes" rows="6" placeholder="ä¾‹ï¼šQ3 05:22 ä¸»éšŠ 10:0 æ”»å‹¢ï¼Œ#7 ä¸‰åˆ†è¿½å¹³"></textarea>
        </section>
      </div>
    </div>

    <!-- çƒå“¡ç´¢å¼• View -->
    <div id="playersView" class="view">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div class="label">çƒå“¡ç´¢å¼• / æ–°å¢çƒå“¡</div>
          <span class="chip">å¯ç›´æ¥é»è¡¨æ ¼ç·¨è¼¯ï¼›PF æœƒåŒæ­¥åœ˜éšŠçŠ¯è¦ï¼›5 çŠ¯è‡ªå‹•é€€å ´</span>
        </div>
        <div class="grid grid-2" style="margin-top:8px">
          <input id="pNum" type="number" placeholder="èƒŒè™Ÿï¼ˆæ•¸å­—ï¼‰"/>
          <input id="pName" placeholder="å§“å"/>
          <select id="pTeam">
            <option value="home">ä¸»éšŠ</option>
            <option value="away">å®¢éšŠ</option>
          </select>
          <input id="pPos" placeholder="ä½ç½®ï¼ˆG/F/Cï¼‰"/>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="addPlayer" class="btn-accent">åŠ å…¥åå–®</button>
          <span class="muted">é‡è¤‡èƒŒè™Ÿæœƒè¦†è“‹è©²éšŠåŒèƒŒè™Ÿã€‚</span>
        </div>

        <div style="margin-top:12px;max-height:460px;overflow:auto;border:1px solid var(--line);border-radius:10px">
          <table id="playersTbl">
            <thead>
              <tr>
                <th>éšŠä¼</th><th>èƒŒè™Ÿ</th><th>å§“å</th><th>ä½ç½®</th>
                <th>åˆ†</th><th>çŠ¯</th><th>åŠ©</th><th>æ¿</th><th>æŠ„</th><th>é˜»</th><th>å¤±</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody><!-- rows --></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <script>
  // ===== IndexedDB åŸºç¤ =====
  const DB_NAME = 'basket-scoreboard';
  const DB_VER  = 6; // FIBAçŠ¯è¦äº‹ä»¶ï¼‹FouledOut
  let db;
  function openDB(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = (e)=>{
        const db = e.target.result;
        if(!db.objectStoreNames.contains('players')){
          const s = db.createObjectStore('players',{ keyPath:'id' });
          s.createIndex('team','team',{unique:false});
        }
        if(!db.objectStoreNames.contains('game')){
          db.createObjectStore('game',{ keyPath:'k' });
        }
        if(!db.objectStoreNames.contains('file')){
          db.createObjectStore('file',{ keyPath:'k' });
        }
      };
      req.onsuccess = ()=>{ db=req.result; resolve(db); };
      req.onerror = ()=>reject(req.error);
    });
  }
  function tx(store,mode='readonly'){ return db.transaction(store,mode).objectStore(store); }
  const put = (store,val)=>new Promise((res,rej)=>{ const r=tx(store,'readwrite').put(val); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });
  const get = (store,key)=>new Promise((res,rej)=>{ const r=tx(store).get(key); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
  const del = (store,key)=>new Promise((res,rej)=>{ const r=tx(store,'readwrite').delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); });
  const allPlayers = ()=>new Promise((res,rej)=>{ const r = tx('players').getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error); });

  // ===== å¸¸æ•¸ & ç‹€æ…‹ =====
  const BONUS_LIMIT = 5; // æ¯ç¯€ç¬¬ 5 æ¬¡åœ˜éšŠçŠ¯çŠ¯è¦é–‹å§‹åŠ ç½°
  const FOUL_OUT = 5;   // å€‹äºº 5 çŠ¯é€€å ´ï¼ˆFIBAï¼‰
  const state = {
    gameTitle:'',
    period:1,
    home:{score:0,timeouts:6,teamFouls:0},
    away:{score:0,timeouts:6,teamFouls:0},
    shot:{ ms:24000, running:false, lastTs:null, poss:'home' },
    game:{ ms:12*60*1000, totalMs:12*60*1000, running:false, lastTs:null, linkShot:false },
    ui:{ view:'scoreView' }
  };

  // ===== åˆå§‹åŒ–/å„²å­˜ =====
  async function loadState(){
    const saved = await get('game','state');
    if(saved){ Object.assign(state,saved.v); }
    document.getElementById('gameTitle').value = state.gameTitle || '';
    setScore('home', state.home.score); setScore('away', state.away.score);
    renderTeamFouls('home'); renderTeamFouls('away');
    document.getElementById('homeTO').textContent = state.home.timeouts;
    document.getElementById('awayTO').textContent = state.away.timeouts;
    renderPeriod();
    await renderPlayers();
    updateShotUI(true); updateGameUI(true);
    setView(state.ui.view || 'scoreView');
    populateFoulSelect();
    if(state.shot.running) startShot(true);
    if(state.game.running) startGame(true);
  }
  async function saveState(){ await put('game',{k:'state', v:structuredClone(state)}); }

  // ===== ç¯€æ¬¡é¡¯ç¤ºï¼ˆå« OTï¼‰ =====
  function periodLabel(n){ return n<=4 ? `ç¬¬${n}ç¯€` : `OT${n-4}`; }
  function renderPeriod(){ document.getElementById('period').textContent = periodLabel(state.period); }

  // ===== æ¯”åˆ† =====
  function setScore(side, val){
    state[side].score = Math.max(0, val|0);
    document.getElementById(side+'Score').textContent = state[side].score;
    saveState();
  }

  // ===== åœ˜éšŠçŠ¯è¦ =====
  function renderTeamFouls(side){
    const n = Math.max(0, state[side].teamFouls|0);
    document.getElementById(side+'Fouls').textContent = n;
    const bonusEl = document.getElementById(side+'Bonus');
    bonusEl.style.display = n >= BONUS_LIMIT ? 'inline-flex' : 'none';
    saveState();
  }
  function addTeamFoul(side, delta){
    state[side].teamFouls = Math.max(0, (state[side].teamFouls|0) + delta);
    renderTeamFouls(side);
  }
  function resetTeamFouls(){
    state.home.teamFouls = 0; state.away.teamFouls = 0;
    renderTeamFouls('home'); renderTeamFouls('away');
  }

  // ===== çƒå“¡è¡¨ï¼ˆå« Fouled Out æ¨™ç¤ºï¼‰ =====
  function idOf(team,num){ return `${team}#${num}`; }

  function playerRowClass(p){ return (p.PF|0) >= FOUL_OUT ? 'fouledout' : ''; }
  function playerFouledOutText(p){ return (p.PF|0) >= FOUL_OUT ? 'ï¼ˆFouled Outï¼‰' : ''; }

  function trForPlayer(p){
    const tr = document.createElement('tr'); tr.dataset.id=p.id; tr.className = playerRowClass(p);
    const cells = [
      ['team', p.team==='home'?'ä¸»éšŠ':'å®¢éšŠ', false],
      ['number', p.number, true],
      ['name', p.name||'', true],
      ['pos', p.pos||'', true],
      ['PTS', p.PTS|0, false],
      ['PF',  p.PF|0,  false],
      ['AST', p.AST|0, false],
      ['REB', p.REB|0, false],
      ['STL', p.STL|0, false],
      ['BLK', p.BLK|0, false],
      ['TOV', p.TOV|0, false],
    ];
    for(const [k,val,editable] of cells){
      const td = document.createElement('td');
      td.className = ['PTS','PF','AST','REB','STL','BLK','TOV'].includes(k)?'mono':'';
      td.textContent = k==='PF' ? `${val}${playerFouledOutText(p)?' *':''}` : val;
      if(editable){
        td.contentEditable = true;
        td.addEventListener('blur', async ()=>{
          const storeVal = await get('players', p.id);
          if(!storeVal) return;
          if(k==='number'){
            const newNum = parseInt(td.textContent||'0',10)||0;
            if(newNum!==storeVal.number){
              await del('players', storeVal.id);
              storeVal.number = newNum;
              storeVal.id = idOf(storeVal.team, newNum);
            }
          }else{
            storeVal[k] = td.textContent.trim();
          }
          await put('players', storeVal);
          renderPlayers(); populateFoulSelect();
        });
      }
      tr.appendChild(td);
    }
    const op = document.createElement('td');
    const pfPlus = document.createElement('button');
    pfPlus.textContent = '+ çŠ¯è¦'; pfPlus.className='opbtn btn-warn';
    pfPlus.disabled = (p.PF|0) >= FOUL_OUT;
    pfPlus.addEventListener('click', ()=> adjustPersonalFoul(p.id, +1));

    const pfMinus = document.createElement('button');
    pfMinus.textContent = '- çŠ¯è¦'; pfMinus.className='opbtn';
    pfMinus.addEventListener('click', ()=> adjustPersonalFoul(p.id, -1));

    const delBtn = document.createElement('button');
    delBtn.textContent='åˆªé™¤'; delBtn.className='opbtn';
    delBtn.addEventListener('click', async ()=>{ await del('players', p.id); renderPlayers(); populateFoulSelect(); });

    op.appendChild(pfPlus); op.appendChild(pfMinus); op.appendChild(delBtn);
    tr.appendChild(op);
    return tr;
  }

  async function renderPlayers(){
    const players = await allPlayers();
    const tbody = document.querySelector('#playersTbl tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    players.sort((a,b)=> (a.team===b.team?0:(a.team==='home'?-1:1)) || (a.number-b.number));
    for(const p of players){ tbody.appendChild(trForPlayer(p)); }
  }

  async function adjustPersonalFoul(pid, delta){
    const rec = await get('players', pid); if(!rec) return;
    const before = rec.PF|0;
    const after = Math.max(0, before + delta);
    if(after === before) return;
    rec.PF = after;
    await put('players', rec);
    addTeamFoul(rec.team, delta);
    await renderPlayers(); populateFoulSelect();
    // Fouled out
    if(after >= FOUL_OUT && before < FOUL_OUT){
      alert(`çƒå“¡ #${rec.number} ${rec.name} å·² 5 çŠ¯é€€å ´ï¼Œè«‹ç›¡é€Ÿæ›äººã€‚`);
      // è¨˜éŒ„å‚™è¨»
      const notes = document.getElementById('notes');
      notes.value += (notes.value?'\r\n':'') + `ã€${periodLabel(state.period)}ã€‘#${rec.number} ${rec.name} 5 çŠ¯é€€å ´`;
    }
  }

  // ===== Tabs =====
  function setView(viewId){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(viewId).classList.add('active');
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.view===viewId));
    state.ui.view = viewId; saveState();
  }
  document.querySelectorAll('.tab').forEach(btn=> btn.addEventListener('click', ()=> setView(btn.dataset.view)));

  // ===== Shot Clockï¼ˆ>8sï¼šæ•´ç§’ï¼›â‰¤8sï¼šå…©ä½å°æ•¸ï¼‰ =====
  let shotTimer = null, lastShownWhole = null;
  function fmtShot(ms){ const s = Math.max(0, ms)/1000; return s>8 ? String(Math.ceil(s|0)) : s.toFixed(2); }
  function updateShotUI(force=false){
    const d = document.getElementById('shotDisplay'), pos = document.getElementById('shotPos');
    const s = state.shot.ms/1000;
    d.classList.toggle('shot-danger', s<=8);
    if(s>8 && !force){
      const whole = Math.ceil(s);
      if(whole===lastShownWhole){ pos.textContent = `çƒæ¬Šï¼š${state.shot.poss==='home'?'ä¸»éšŠ':'å®¢éšŠ'}${state.shot.running?'ï¼ˆè¨ˆæ™‚ä¸­ï¼‰':''}`; return; }
      lastShownWhole = whole;
    }
    d.textContent = fmtShot(state.shot.ms);
    pos.textContent = `çƒæ¬Šï¼š${state.shot.poss==='home'?'ä¸»éšŠ':'å®¢éšŠ'}${state.shot.running?'ï¼ˆè¨ˆæ™‚ä¸­ï¼‰':''}`;
    saveState();
  }
  function buzzer(){ try{ const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o = ctx.createOscillator(), g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='square'; o.frequency.value= 440; g.gain.setValueAtTime(0.001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime+0.01); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.6); o.stop(ctx.currentTime+0.65); ctx.close(); }, 600);}catch(e){} }
  function pickShotInterval(){ return (state.shot.ms/1000 > 8) ? 200 : 50; }
  function startShot(){
    if(shotTimer) clearInterval(shotTimer);
    state.shot.running = true; state.shot.lastTs = performance.now();
    const tick = ()=>{
      const now = performance.now(), elapsed = now - state.shot.lastTs; state.shot.lastTs = now; state.shot.ms -= elapsed;
      if(state.shot.ms <= 0){
        state.shot.ms = 0; updateShotUI(true);
        clearInterval(shotTimer); shotTimer=null; state.shot.running=false; buzzer(); shotViolationAuto();
      }else{
        updateShotUI();
        const newInt = pickShotInterval(); if(newInt !== shotTickInterval){ clearInterval(shotTimer); shotTickInterval=newInt; shotTimer=setInterval(tick, shotTickInterval); }
      }
    };
    let shotTickInterval = pickShotInterval(); shotTimer = setInterval(tick, shotTickInterval);
    updateShotUI(true);
  }
  function pauseShot(){ if(shotTimer){ clearInterval(shotTimer); shotTimer=null; } state.shot.running=false; state.shot.lastTs=null; updateShotUI(true); }
  function resetShot(ms, {autoRunIfLinked=false}={}){ state.shot.ms = ms; state.shot.lastTs = performance.now(); lastShownWhole = null; updateShotUI(true); if(state.shot.running){ clearInterval(shotTimer); startShot(); } if(autoRunIfLinked && state.game.linkShot && state.game.running && !state.shot.running){ startShot(); } }
  function swapPossession(){ state.shot.poss = (state.shot.poss==='home'?'away':'home'); updateShotUI(true); }
  async function shotViolationAuto(){
    const team = state.shot.poss;
    const notes = document.getElementById('notes');
    notes.value += (notes.value?'\r\n':'') + `ã€${new Date().toLocaleTimeString()}ã€‘${team==='home'?'ä¸»éšŠ':'å®¢éšŠ'} 24ç§’é•ä¾‹`;
    swapPossession(); resetShot(24000, {autoRunIfLinked:true}); await saveState();
  }
  async function shotViolationManual(){ pauseShot(); buzzer(); await shotViolationAuto(); }

  // ===== Game Clockï¼ˆæœ€å¾Œ 1 åˆ†é˜é¡¯ç¤ºåˆ° 0.01ï¼‰ =====
  let gameTimer = null, gameLastShownSec = null;
  function fmtGame(ms){
    const t = Math.max(0, ms|0), s = Math.floor(t/1000), m = Math.floor(s/60), sec = s%60;
    if(s >= 60){ return `${String(m).padStart(1,'0')}:${String(sec).padStart(2,'0')}`; }
    const hundred = Math.floor((t%1000)/10); return `${String(m).padStart(1,'0')}:${String(sec).padStart(2,'0')}.${String(hundred).padStart(2,'0')}`;
  }
  function updateGameUI(force=false){
    const d = document.getElementById('gameDisplay'), info = document.getElementById('gameInfo');
    const s = Math.floor(state.game.ms/1000);
    d.classList.toggle('game-danger', s<60);
    if(s>=60 && !force){ if(s===gameLastShownSec){ info.textContent = `é•·åº¦ï¼š${fmtGame(state.game.totalMs)}`; return; } gameLastShownSec = s; }
    d.textContent = fmtGame(state.game.ms);
    info.textContent = `é•·åº¦ï¼š${fmtGame(state.game.totalMs)}`;
    document.getElementById('toggleLink').textContent = `èˆ‡ 24s é€£å‹•ï¼š${state.game.linkShot?'é–‹':'é—œ'}`;
    saveState();
  }
  function startGame(){
    if(gameTimer) clearInterval(gameTimer);
    state.game.running = true; state.game.lastTs = performance.now();
    if(state.game.linkShot && !state.shot.running) startShot();
    const tick = ()=>{
      const now = performance.now(), elapsed = now - state.game.lastTs; state.game.lastTs = now; state.game.ms -= elapsed;
      if(state.game.ms <= 0){ state.game.ms = 0; updateGameUI(true); clearInterval(gameTimer); gameTimer=null; state.game.running=false; buzzer(); nextPeriod(); }
      else{ updateGameUI(); }
    };
    gameTimer = setInterval(tick, (state.game.ms>=60*1000)? 250 : 50); updateGameUI(true);
  }
  function pauseGame(){ if(gameTimer){ clearInterval(gameTimer); gameTimer=null; } state.game.running=false; state.game.lastTs=null; if(state.game.linkShot && state.shot.running) pauseShot(); updateGameUI(true); }
  function setGameLength(mins){ const ms = mins*60*1000; state.game.totalMs = ms; state.game.ms = ms; gameLastShownSec = null; updateGameUI(true); if(state.game.running){ clearInterval(gameTimer); startGame(); } }
  function resetGameClock(){ state.game.ms = state.game.totalMs; gameLastShownSec = null; updateGameUI(true); }
  function nextPeriod(){
    state.period += 1;
    if(state.period <= 4){ resetGameClock(); } else { state.game.totalMs = 5*60*1000; resetGameClock(); }
    resetTeamFouls(); resetShot(24000, {autoRunIfLinked:true}); renderPeriod(); saveState();
  }

  // ===== FIBA çŠ¯è¦äº‹ä»¶ =====
  async function populateFoulSelect(){
    const sel = document.getElementById('foulPlayer'); if(!sel) return;
    const info = document.getElementById('foulPlayerInfo');
    const players = await allPlayers();
    players.sort((a,b)=> (a.team===b.team?0:(a.team==='home'?-1:1)) || (a.number-b.number));
    sel.innerHTML='';
    for(const p of players){
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `[${p.team==='home'?'ä¸»':'å®¢'}] #${p.number} ${p.name}ï¼ˆPF ${p.PF|0}ï¼‰`;
      sel.appendChild(opt);
    }
    sel.onchange = async ()=>{
      const p = await get('players', sel.value); if(!p){ info.textContent=''; return; }
      info.textContent = `æ‰€å±¬ï¼š${p.team==='home'?'ä¸»éšŠ':'å®¢éšŠ'}ï½œç¾ PFï¼š${p.PF|0}${(p.PF|0)>=FOUL_OUT?'ï¼ˆFouled Outï¼‰':''}`;
    };
    sel.dispatchEvent(new Event('change'));
  }
  function otherTeam(team){ return team==='home'?'away':'home'; }
  function note(line){ const n = document.getElementById('notes'); n.value += (n.value?'\r\n':'') + line; }

  async function foulCommon(pid, {countTeamFoul=true, addPersonal=true}={}){
    const p = await get('players', pid); if(!p) { alert('è«‹å…ˆæ–°å¢çƒå“¡'); return null; }
    if(addPersonal){ await adjustPersonalFoul(pid, +1); } // å…§å«åŒæ­¥åœ˜éšŠçŠ¯è¦
    else if(countTeamFoul){ addTeamFoul(p.team, +1); }
    return p;
  }

  // é˜²å®ˆçŠ¯è¦ï¼ˆéæŠ•ç±ƒï¼‰
  document.getElementById('btnDefFoul').onclick = async ()=>{
    const pid = document.getElementById('foulPlayer').value; const p = await foulCommon(pid);
    if(!p) return;
    const defTeam = p.team, offTeam = otherTeam(defTeam);
    const isBonus = state[defTeam].teamFouls >= BONUS_LIMIT;
    // ç½°çƒé‚è¼¯
    if(isBonus){
      pauseGame(); pauseShot();
      note(`ã€${periodLabel(state.period)}ã€‘#${p.number} ${p.name} é˜²å®ˆçŠ¯è¦ â†’ ${offTeam==='home'?'ä¸»éšŠ':'å®¢éšŠ'} å…©ç½°ï¼ˆåŠ ç½°ï¼‰`);
      // çƒæ¬Šä¿æŒç½°å¾Œæƒ…å¢ƒï¼Œä¸è‡ªå‹•è®Šæ›´ï¼›ç­‰ä½ è™•ç†ç½°å¾Œç™¼ç”Ÿçš„çƒæ¬Š
    }else{
      // éåŠ ç½°ï¼šå°æ–¹å‰å ´ç™¼çƒ 14sï¼ˆç°¡åŒ–ï¼›è‹¥åœ¨å¾Œå ´è«‹æ‰‹å‹•æŒ‰ 24ï¼‰
      swapPossession(); if(state.shot.poss!==offTeam) swapPossession(); // è¨­ç‚ºé€²æ”»æ–¹
      resetShot(14000, {autoRunIfLinked:true});
      note(`ã€${periodLabel(state.period)}ã€‘#${p.number} ${p.name} é˜²å®ˆçŠ¯è¦ï¼ˆéåŠ ç½°ï¼‰â†’ ${offTeam==='home'?'ä¸»éšŠ':'å®¢éšŠ'} å‰å ´ç™¼é‚Šç·šçƒ 14s`);
    }
  };

  // é€²æ”»çŠ¯è¦ï¼ˆç„¡ç½°ï¼‰
  document.getElementById('btnOffFoul').onclick = async ()=>{
    const pid = document.getElementById('foulPlayer').value; const p = await foulCommon(pid);
    if(!p) return;
    const defTeam = otherTeam(p.team);
    swapPossession(); if(state.shot.poss!==defTeam) swapPossession(); // äº¤çµ¦å°æ–¹
    resetShot(24000, {autoRunIfLinked:true});
    note(`ã€${periodLabel(state.period)}ã€‘#${p.number} ${p.name} é€²æ”»çŠ¯è¦ â†’ ${defTeam==='home'?'ä¸»éšŠ':'å®¢éšŠ'} çƒæ¬Š 24sï¼ˆç„¡ç½°ï¼‰`);
  };

  // æŠ•ç±ƒçŠ¯è¦ 2 åˆ†ï¼ˆæœªä¸­ï¼‰
  document.getElementById('btnShoot2').onclick = async ()=>{
    const pid = document.getElementById('foulPlayer').value; const p = await foulCommon(pid);
    if(!p) return;
    const offTeam = otherTeam(p.team);
    pauseGame(); pauseShot();
    note(`ã€${periodLabel(state.period)}ã€‘#${p.number} ${p.name} å° ${offTeam==='home'?'ä¸»éšŠ':'å®¢éšŠ'} æŠ•ç±ƒçŠ¯è¦ï¼ˆ2 åˆ†æœªä¸­ï¼‰â†’ 2 ç½°`);
  };

  // æŠ•ç±ƒçŠ¯è¦ 3 åˆ†ï¼ˆæœªä¸­ï¼‰
  document.getElementById('btnShoot3').onclick = async ()=>{
    const pid = document.getElementById('foulPlayer').value; const p = await foulCommon(pid);
    if(!p) return;
    const offTeam = otherTeam(p.team);
    pauseGame(); pauseShot();
    note(`ã€${periodLabel(state.period)}ã€‘#${p.number} ${p.name} å° ${offTeam==='home'?'ä¸»éšŠ':'å®¢éšŠ'} æŠ•ç±ƒçŠ¯è¦ï¼ˆ3 åˆ†æœªä¸­ï¼‰â†’ 3 ç½°`);
  };

  // æŠ€è¡“çŠ¯è¦ï¼ˆ1 ç½°ï¼Œçƒæ¬Šä¸è®Šï¼›è¨ˆå…¥åœ˜éšŠçŠ¯ä½†ä¸ç®—å€‹äººçŠ¯ï¼‰
  document.getElementById('btnTech').onclick = async ()=>{
    const pid = document.getElementById('foulPlayer').value; const p = await get('players', pid);
    if(!p) { alert('è«‹å…ˆæ–°å¢çƒå“¡'); return; }
    addTeamFoul(p.team, +1);
    pauseGame(); pauseShot();
    note(`ã€${periodLabel(state.period)}ã€‘æŠ€è¡“çŠ¯è¦ï¼š#${p.number} ${p.name} â†’ å°æ–¹ 1 ç½°ï¼Œçƒæ¬Šä¸è®Š`);
  };

  // éé«”è‚²é“å¾·çŠ¯è¦ï¼ˆ2 ç½° + çƒæ¬Šï¼‰
  document.getElementById('btnUnsport').onclick = async ()=>{
    const pid = document.getElementById('foulPlayer').value; const p = await foulCommon(pid);
    if(!p) return;
    const offTeam = otherTeam(p.team);
    pauseGame(); pauseShot();
    // ç½°å¾Œçµ¦å°æ–¹çƒæ¬Š 24s
    swapPossession(); if(state.shot.poss!==offTeam) swapPossession();
    resetShot(24000);
    note(`ã€${periodLabel(state.period)}ã€‘#${p.number} ${p.name} éé«”è‚²é“å¾·çŠ¯è¦ â†’ ${offTeam==='home'?'ä¸»éšŠ':'å®¢éšŠ'} 2 ç½° + çƒæ¬Šï¼ˆ24sï¼‰`);
  };

  // ===== ç¶å®šï¼ˆå…¶ä»–ï¼‰ =====
  // Shot
  document.getElementById('shotStart').onclick = ()=> startShot();
  document.getElementById('shotPause').onclick = ()=> pauseShot();
  document.getElementById('shotReset24').onclick = ()=> resetShot(24000, {autoRunIfLinked:true});
  document.getElementById('shotReset14').onclick = ()=> resetShot(14000, {autoRunIfLinked:true});
  document.getElementById('shotMinus').onclick = ()=>{ state.shot.ms = Math.max(0, state.shot.ms-1000); updateShotUI(true); if(state.shot.running){ clearInterval(shotTimer); startShot(); } };
  document.getElementById('shotPlus').onclick  = ()=>{ state.shot.ms = Math.min(24000, state.shot.ms+1000); updateShotUI(true); if(state.shot.running){ clearInterval(shotTimer); startShot(); } };
  document.getElementById('shotSwap').onclick  = ()=> { swapPossession(); if(state.game.linkShot && state.game.running) startShot(); };
  document.getElementById('shotViolation').onclick = ()=> shotViolationManual();
  // å¿«é€Ÿæƒ…å¢ƒ
  document.getElementById('qaOffReb14').onclick = ()=> resetShot(14000, {autoRunIfLinked:true});
  document.getElementById('qaChangePoss24').onclick = ()=>{ swapPossession(); resetShot(24000, {autoRunIfLinked:true}); };

  // Game
  document.getElementById('gameStart').onclick = ()=> startGame();
  document.getElementById('gamePause').onclick = ()=> pauseGame();
  document.getElementById('gameReset').onclick = ()=> resetGameClock();
  document.getElementById('set12').onclick = ()=> setGameLength(12);
  document.getElementById('set10').onclick = ()=> setGameLength(10);
  document.getElementById('set5').onclick  = ()=> setGameLength(5);
  document.getElementById('toggleLink').onclick = ()=>{ state.game.linkShot = !state.game.linkShot; updateGameUI(true); };

  // æ¯”åˆ† + æš«åœ
  document.querySelectorAll('[data-add]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ const [side,delta] = btn.dataset.add.split(':'); setScore(side, state[side].score + parseInt(delta,10)); });
  });
  document.querySelectorAll('[data-tos]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ const [side,delta] = btn.dataset.tos.split(':'); state[side].timeouts = Math.max(0, (state[side].timeouts|0) + parseInt(delta,10)); document.getElementById(side+'TO').textContent = state[side].timeouts; saveState(); });
  });

  // åœ˜éšŠçŠ¯è¦
  document.getElementById('homeFoulsReset').onclick = ()=>{ state.home.teamFouls=0; renderTeamFouls('home'); };
  document.getElementById('awayFoulsReset').onclick = ()=>{ state.away.teamFouls=0; renderTeamFouls('away'); };
  document.querySelectorAll('[data-tf]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ const [side,delta] = btn.dataset.tf.split(':'); addTeamFoul(side, parseInt(delta,10)); });
  });

  // ç¯€æ¬¡ï¼ˆæ‰‹å‹•ï¼‰
  document.getElementById('periodInc').onclick = ()=>{ state.period = (state.period|0)+1; if(state.period>4){ state.game.totalMs = 5*60*1000; } resetGameClock(); resetTeamFouls(); resetShot(24000, {autoRunIfLinked:true}); renderPeriod(); saveState(); };
  document.getElementById('periodDec').onclick = ()=>{ state.period = Math.max(1,(state.period|0)-1); if(state.period>4){ state.game.totalMs = 5*60*1000; } resetGameClock(); resetTeamFouls(); resetShot(24000, {autoRunIfLinked:true}); renderPeriod(); saveState(); };

  // æ–°å¢çƒå“¡
  document.getElementById('addPlayer').onclick = async ()=>{
    const number = parseInt(document.getElementById('pNum').value||'0',10);
    const name   = document.getElementById('pName').value.trim();
    const team   = document.getElementById('pTeam').value;
    const pos    = document.getElementById('pPos').value.trim();
    if(!number || !name){ alert('è«‹è¼¸å…¥èƒŒè™Ÿèˆ‡å§“å'); return; }
    const id = idOf(team, number);
    const base = await get('players', id) || { id, team, number, name:'', pos:'', PTS:0, PF:0, AST:0, REB:0, STL:0, BLK:0, TOV:0 };
    base.name=name; base.pos=pos;
    await put('players', base);
    document.getElementById('pNum').value=''; document.getElementById('pName').value=''; document.getElementById('pPos').value='';
    await renderPlayers(); populateFoulSelect();
  };

  // åŒ¯å‡º TXTï¼ˆUTF-8 BOM + CRLFï¼‰
  function buildTxt(players){
    const L = [];
    L.push(`# ${state.gameTitle || 'æœªå‘½åæ¯”è³½'}`);
    L.push(`# Period: ${periodLabel(state.period)}`);
    L.push(`# Score: HOME ${state.home.score} - AWAY ${state.away.score}`);
    L.push(`# TeamFouls: HOME ${state.home.teamFouls} / AWAY ${state.away.teamFouls}${(state.home.teamFouls>=BONUS_LIMIT||state.away.teamFouls>=BONUS_LIMIT)?' (Bonus in effect)':''}`);
    L.push(`# Timeouts: HOME ${state.home.timeouts} / AWAY ${state.away.timeouts}`);
    L.push(`# GameClock: ${fmtGame(state.game.ms)} / ${fmtGame(state.game.totalMs)}${state.game.running?' (running)':''}`);
    L.push(`# Possession: ${state.shot.poss==='home'?'HOME':'AWAY'}`);
    const s = state.shot.ms/1000; L.push(`# ShotClock: ${s>8?Math.ceil(s):s.toFixed(2)}s ${state.shot.running?'(running)':''}`);
    L.push(''); L.push('Team,Number,Name,Pos,PTS,PF,AST,REB,STL,BLK,TOV');
    players.sort((a,b)=> (a.team===b.team?0:(a.team==='home'?-1:1)) || (a.number-b.number))
      .forEach(p=>L.push(`${p.team},${p.number},${p.name},${p.pos},${p.PTS|0},${p.PF|0},${p.AST|0},${p.REB|0},${p.STL|0},${p.BLK|0},${p.TOV|0}`));
    const notes = (document.getElementById('notes')?.value||'').trim();
    if(notes){ L.push(''); L.push('--- Notes ---'); L.push(notes); }
    return L.join('\r\n');
  }
  async function getSavedHandle(){ const rec = await get('file','txtHandle'); return rec?.handle || null; }
  async function setSavedHandle(handle){ try{ if (handle && handle.requestPermission) await handle.requestPermission({mode:'readwrite'});}catch(e){} await put('file',{k:'txtHandle', handle}); }
  async function saveAsTxt(){
    const players = await allPlayers(); const txt = buildTxt(players); const bom = '\ufeff';
    if(window.showSaveFilePicker){
      const handle = await window.showSaveFilePicker({ suggestedName: (state.gameTitle||'game') + '.txt', types: [{ description: 'Text', accept: {'text/plain':['.txt']} }] });
      const writable = await handle.createWritable(); await writable.write(bom + txt); await writable.close(); await setSavedHandle(handle);
      alert('å·²åŒ¯å‡º TXT ä¸¦è¨˜ä½æª”æ¡ˆä½ç½®ã€‚ä¹‹å¾Œå¯ç”¨ã€Œæ›´æ–°ã€è¦†å¯«ã€‚');
    }else{
      const blob = new Blob([bom, txt], {type:'text/plain;charset=utf-8'}); const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = (state.gameTitle||'game') + '-' + new Date().toISOString().replaceAll(':','').slice(0,15)+'.txt'; a.click(); URL.revokeObjectURL(a.href);
      alert('ç€è¦½å™¨ä¸æ”¯æ´è¦†å¯«åŒæª”ï¼Œå·²ä¸‹è¼‰æ–°æª”ï¼ˆå« UTF-8 BOMï¼‰ã€‚');
    }
  }
  async function updateTxt(){
    const handle = await getSavedHandle(); if(!handle){ await saveAsTxt(); return; }
    try{ const players = await allPlayers(); const txt = buildTxt(players); const writable = await handle.createWritable(); await writable.write('\ufeff' + txt); await writable.close(); alert('å·²æ›´æ–°ä¸¦è¦†å¯«åŸæª”ã€‚'); }
    catch(err){ console.warn(err); await saveAsTxt(); }
  }
  document.getElementById('btnExport').onclick = saveAsTxt;
  document.getElementById('btnUpdate').onclick = updateTxt;

  // é‡ç½®æ•´å ´
  document.getElementById('btnReset').onclick = async ()=>{
    if(!confirm('ç¢ºå®šè¦æ¸…ç©ºæœ¬å ´è³‡æ–™ï¼Ÿï¼ˆçƒå“¡èˆ‡åˆ†æ•¸ç­‰å°‡æ¸…ç©ºï¼‰')) return;
    db.close(); await new Promise((res,rej)=>{ const delReq = indexedDB.deleteDatabase(DB_NAME); delReq.onsuccess=()=>res(); delReq.onerror=()=>rej(delReq.error); });
    await openDB(); location.reload();
  };

  // å•Ÿå‹•
  (async function init(){ await openDB(); await loadState(); })();
  </script>
</body>
</html>